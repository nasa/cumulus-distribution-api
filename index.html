<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8' />
    <meta http-equiv='X-UA-Compatible' content='IE=11' />
    <title>Cumulus Distribution API</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link href='css/base.css' rel='stylesheet' />
    <link href='css/style.css' rel='stylesheet' />
    <link href='css/railscasts.css' rel='stylesheet' />
  </head>
  <body>
    <!--START--><div id='app'><div class="container unlimiter" data-reactroot="" data-reactid="1" data-react-checksum="-373503765"><div class="fixed-top fixed-right space-left16" data-reactid="2"><div class="fill-light col6 pin-right" data-reactid="3"></div></div><div class="space-top5 scroll-styled overflow-auto pad1 width16 sidebar fixed-left fill-dark dark" data-reactid="4"><div class="pad0x small" data-reactid="5"><div class="small pad0x quiet space-top1" data-reactid="6">Introduction</div><a href="#cumulus-distribution-api" class="line-height15 pad0x pad00y quiet block " data-reactid="7">Cumulus Distribution API</a><div class="small pad0x quiet space-top1" data-reactid="8">Versioning</div><a href="#versioning-1" class="line-height15 pad0x pad00y quiet block " data-reactid="9">Versioning</a><div class="small pad0x quiet space-top1" data-reactid="10">Data Access</div><a href="#distribution" class="line-height15 pad0x pad00y quiet block " data-reactid="11">Distribution</a><a href="#head" class="line-height15 pad0x pad00y quiet block " data-reactid="12">HEAD</a><a href="#get" class="line-height15 pad0x pad00y quiet block " data-reactid="13">GET</a><div class="small pad0x quiet space-top1" data-reactid="14">Authentication</div><a href="#root" class="line-height15 pad0x pad00y quiet block " data-reactid="15">Root</a><a href="#login" class="line-height15 pad0x pad00y quiet block " data-reactid="16">Login</a><a href="#logout" class="line-height15 pad0x pad00y quiet block " data-reactid="17">Logout</a><div class="small pad0x quiet space-top1" data-reactid="18">Bucket Map</div><a href="#bucket-map-1" class="line-height15 pad0x pad00y quiet block " data-reactid="19">Bucket Map</a><div class="small pad0x quiet space-top1" data-reactid="20">S3 Access</div><a href="#temporary-s3-credentials" class="line-height15 pad0x pad00y quiet block " data-reactid="21">Temporary S3 Credentials</a><div class="small pad0x quiet space-top1" data-reactid="22">S3 Access README</div><a href="#temporary-s3-credentials-readme" class="line-height15 pad0x pad00y quiet block " data-reactid="23">Temporary S3 Credentials README</a></div></div><div class="space-left16" data-reactid="24"><div class="" data-reactid="25"><div class="clearfix" data-reactid="26"><div data-title="Cumulus Distribution API" class="keyline-top section contain clearfix " data-reactid="27"><div class="space-bottom8 col6 pad2x prose clip" data-reactid="28"><h2 id="cumulus-distribution-api">Cumulus Distribution API</h2>
<p>The Cumulus Distribution API allows users to access protected data from Cumulus when authenticated via the configured OAuth provider.  The supported OAuth providers are <a href="https://urs.earthdata.nasa.gov">Earthdata Login</a> and <a href="https://auth.csdap.uat.earthdatacloud.nasa.gov/">Cognito</a>.</p>
</div></div><div data-title="Versioning" class="keyline-top section contain clearfix " data-reactid="29"><div class="space-bottom8 col6 pad2x prose clip" data-reactid="30"><h2 id="versioning-1">Versioning</h2>
<p>The Cumulus Distribution API is versioned and the current version is v1. Retrieve the latest API version from Cumulus.</p>
<p>To use any version, include the version number in the path before the query endpoint. <code>{API_URL}/{version}/{query}</code></p>
</div><div class="space-bottom4 col6 pad2 prose clip fill-light space-top5" data-reactid="31"><div class='endpoint dark fill-dark round '>
      <div class='round-left pad0y pad1x fill-lighten0 code small endpoint-method'>GET</div>
      <div class='pad0 code small endpoint-url'>/version</div>
    </div>
<h4 id="example-request">Example Request</h4>
<pre class='hljs'>$ curl https://example.com/version</pre>
<h4 id="example-response">Example Response</h4>
<pre class='hljs'>{
    <span class="hljs-attr">"response_version"</span>: <span class="hljs-string">"v1"</span>,
    <span class="hljs-attr">"api_version"</span>: <span class="hljs-string">"1.1.1"</span>
}</pre>
</div></div><div data-title="Distribution" class="keyline-top section contain clearfix " data-reactid="32"><div class="space-bottom8 col6 pad2x prose clip" data-reactid="33"><h2 id="distribution">Distribution</h2>
<p>File downloads through the Cumulus Distribution API are available to the authenticated users via the configured OAuth provider.  Links to these protected files can be found in the metadata from the Common Metadata Repository (CMR).  Protected URLs look like: <a href="https://cumulus-distribution-api/path/to/science-file.hdf">https://cumulus-distribution-api/path/to/science-file.hdf</a>. For any request of protected files, the distribution API ensures the user is authenticated with the OAuth provider then redirects the user to a signed S3 url that will download the requested science file.</p>
</div></div><div data-title="HEAD" class="keyline-top section contain clearfix " data-reactid="34"><div class="space-bottom8 col6 pad2x prose clip" data-reactid="35"><h2 id="head">HEAD</h2>
<p>The Cumulus API wraps the S3 HeadObject method</p>
</div><div class="space-bottom4 col6 pad2 prose clip fill-light space-top5" data-reactid="36"><div class='endpoint dark fill-dark round '>
      <div class='round-left pad0y pad1x fill-lighten0 code small endpoint-method'>HEAD</div>
      <div class='pad0 code small endpoint-url'>/path/to/science-file.hdf</div>
    </div>
<h4 id="example-request-1">Example Request</h4>
<pre class='hljs'>curl --location --head <span class="hljs-string">'https://example.com/path/to/science-file.hdf'</span> \
--header <span class="hljs-string">'Range: bytes=0-1023'</span> \
--header <span class="hljs-string">'Cookie: accessToken=&lt;access-token&gt;'</span></pre>
<h4 id="example-response-1">Example Response</h4>
<pre class='hljs'>HTTP/1.1 200 OK
x-amz-id-2: uLwBLVcaGUv5mDgTQLJTSXrjqxNveiVJN5DRR2oHMIHLS6cLHT8q47UQeX2Y370KK+R7kafhmzE=
x-amz-request-id: 6QVAWF6HMTJ11FCK
Date: Wed, 16 Jun 2021 23:06:20 GMT
Last-Modified: Thu, 10 Jun 2021 18:23:19 GMT
ETag: "8d1ec5c0463e59d26adee87cdbbee816"
Accept-Ranges: bytes
Content-Type: binary/octet-stream
Server: AmazonS3
Content-Length: 1098034</pre>
<h4 id="example-response-body">Example Response Body</h4>
<pre class='hljs'>No Response Body Returned</pre>
</div></div><div data-title="Supported Headers" class="keyline-top section contain clearfix " data-reactid="37"><div class="space-bottom8 col6 pad2x prose clip" data-reactid="38"><h3 id="supported-headers">Supported Headers</h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Value</th>
<th>Passed to HeadObject</th>
<th>Example Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Cookie</code></td>
<td>(optional) bytes=(min byte)-(max byte)</td>
<td><code>false</code></td>
<td><code>curl --location --head 'https://example.com/path/to/science-file.hdf' --header 'Cookie: accessToken=&#x3C;access-token>'</code></td>
</tr>
<tr>
<td><code>Range</code></td>
<td>(optional) bytes=(min byte)-(max byte)</td>
<td><code>true</code></td>
<td><code>curl --location --head 'https://example.com/path/to/science-file.hdf' --header 'Range: bytes=0-1023'</code></td>
</tr>
</tbody>
</table>
<!-- The full list of supported headers can be found [here](https://docs.aws.amazon.com/AmazonS3/latest/API/API_HeadObject.html) -->
</div></div><div data-title="GET" class="keyline-top section contain clearfix " data-reactid="39"><div class="space-bottom8 col6 pad2x prose clip" data-reactid="40"><h2 id="get">GET</h2>
<p>The Cumulus API wraps the S3 GetObject method</p>
</div><div class="space-bottom4 col6 pad2 prose clip fill-light space-top5" data-reactid="41"><div class='endpoint dark fill-dark round '>
      <div class='round-left pad0y pad1x fill-lighten0 code small endpoint-method'>GET</div>
      <div class='pad0 code small endpoint-url'>/path/to/science-file.hdf</div>
    </div>
<h4 id="example-request-2">Example Request</h4>
<pre class='hljs'>curl --location --request GET <span class="hljs-string">'https://example.com/path/to/science-file.hdf'</span> \
--header <span class="hljs-string">'Cookie: accessToken=&lt;access-token'</span></pre>
<h4 id="example-response-2">Example Response</h4>
<pre class='hljs'>HTTP/1.1 200 OK
x-amz-id-2: uLwBLVcaGUv5mDgTQLJTSXrjqxNveiVJN5DRR2oHMIHLS6cLHT8q47UQeX2Y370KK+R7kafhmzE=
x-amz-request-id: 6QVAWF6HMTJ11FCK
Date: Wed, 16 Jun 2021 23:06:20 GMT
Last-Modified: Thu, 10 Jun 2021 18:23:19 GMT
ETag: "8d1ec5c0463e59d26adee87cdbbee816"
Accept-Ranges: bytes
Content-Type: binary/octet-stream
Server: AmazonS3
Content-Length: 1098034</pre>
<h4 id="example-response-body-1">Example Response Body</h4>
<pre class='hljs'>&lt;binary&gt;</pre>
</div></div><div data-title="Supported Headers" class="keyline-top section contain clearfix " data-reactid="42"><div class="space-bottom8 col6 pad2x prose clip" data-reactid="43"><h3 id="supported-headers-1">Supported Headers</h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Value</th>
<th>Passed to HeadObject</th>
<th>Example Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Cookie</code></td>
<td>(optional) bytes=(min byte)-(max byte)</td>
<td><code>false</code></td>
<td><code>curl --request GET 'https://example.com/path/to/science-file.hdf' --header 'Cookie: accessToken=&#x3C;access-token>'</code></td>
</tr>
<tr>
<td><code>Range</code></td>
<td>(optional) bytes=(min byte)-(max byte)</td>
<td><code>true</code></td>
<td><code>curl --request GET 'https://example.com/path/to/science-file.hdf' --header 'Range: bytes=0-1023'</code></td>
</tr>
</tbody>
</table>
</div></div><div data-title="Root" class="keyline-top section contain clearfix " data-reactid="44"><div class="space-bottom8 col6 pad2x prose clip" data-reactid="45"><h2 id="root">Root</h2>
<p>Displays a basic welcome page with login or logout link.</p>
</div><div class="space-bottom4 col6 pad2 prose clip fill-light space-top5" data-reactid="46"><div class='endpoint dark fill-dark round '>
      <div class='round-left pad0y pad1x fill-lighten0 code small endpoint-method'>GET</div>
      <div class='pad0 code small endpoint-url'>/</div>
    </div>
</div></div><div data-title="Login" class="keyline-top section contain clearfix " data-reactid="47"><div class="space-bottom8 col6 pad2x prose clip" data-reactid="48"><h2 id="login">Login</h2>
<p>Validates code against OAuth provider's API, adds an entry to the access tokens table, and redirects to the URI as specified by <code>state</code> parameter or <code>/</code> endpoint.  It is used as a redirect_uri to pass into OAuth provider's authentication service API.</p>
</div><div class="space-bottom4 col6 pad2 prose clip fill-light space-top5" data-reactid="49"><div class='endpoint dark fill-dark round '>
      <div class='round-left pad0y pad1x fill-lighten0 code small endpoint-method'>GET</div>
      <div class='pad0 code small endpoint-url'>/login</div>
    </div>
</div></div><div data-title="Query Parameters" class="keyline-top section contain clearfix " data-reactid="50"><div class="space-bottom8 col6 pad2x prose clip" data-reactid="51"><h3 id="query-parameters">Query Parameters</h3>
<table>
<thead>
<tr>
<th>query string parameter</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>code={string}</code></td>
<td>The authentication code from OAuth provider</td>
</tr>
<tr>
<td><code>state={string}</code></td>
<td>The URI to redirect to after if authentication was successful</td>
</tr>
</tbody>
</table>
</div><div class="space-bottom4 col6 pad2 prose clip fill-light space-top5" data-reactid="52"><h4 id="example-request-3">Example request</h4>
<pre class='hljs'>$ GET https://example.com/login?code=somecode&amp;state=somestate</pre>
</div></div><div data-title="Logout" class="keyline-top section contain clearfix " data-reactid="53"><div class="space-bottom8 col6 pad2x prose clip" data-reactid="54"><h2 id="logout">Logout</h2>
<p>Logs out the API, and removes the access token from the access tokens table.</p>
</div><div class="space-bottom4 col6 pad2 prose clip fill-light space-top5" data-reactid="55"><div class='endpoint dark fill-dark round '>
      <div class='round-left pad0y pad1x fill-lighten0 code small endpoint-method'>GET</div>
      <div class='pad0 code small endpoint-url'>/logout</div>
    </div>
<h4 id="example-request-4">Example request</h4>
<pre class='hljs'>$ GET https://example.com/<span class="hljs-built_in">logout</span></pre>
</div></div><div data-title="Bucket Map" class="keyline-top section contain clearfix " data-reactid="56"><div class="space-bottom8 col6 pad2x prose clip" data-reactid="57"><h2 id="bucket-map-1">Bucket Map</h2>
<p>The Cumulus Distribution API supports an S3 bucket map. The <code>/locate</code> endpoint fetches bucket map paths for a given bucket.
Information about S3 bucket map is available <a href="https://nasa.github.io/cumulus/docs/deployment/cumulus_distribution#s3-bucket-mapping">here</a></p>
<pre><code>GET /locate
</code></pre>
</div></div><div data-title="Query Parameters" class="keyline-top section contain clearfix " data-reactid="58"><div class="space-bottom8 col6 pad2x prose clip" data-reactid="59"><h3 id="query-parameters-1">Query Parameters</h3>
<table>
<thead>
<tr>
<th>query string parameter</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>bucket_name={string}</code></td>
<td>The s3 bucket name</td>
</tr>
</tbody>
</table>
</div><div class="space-bottom4 col6 pad2 prose clip fill-light space-top5" data-reactid="60"><h4 id="example-request-5">Example Request</h4>
<pre class='hljs'>$ curl https://example.com/locate?bucket_name={bucket}</pre>
<h4 id="example-response-3">Example Response</h4>
<pre class='hljs'>[<span class="hljs-string">"/path1/to/bucket"</span>, <span class="hljs-string">"/path2/to/bucket"</span>]</pre>
</div></div><div data-title="Temporary S3 Credentials" class="keyline-top section contain clearfix " data-reactid="61"><div class="space-bottom8 col6 pad2x prose clip" data-reactid="62"><h2 id="temporary-s3-credentials">Temporary S3 Credentials</h2>
<p>The Cumulus API can provide temporary credentials that provide read-only, same-region, direct access to S3 objects.</p>
<p>For Cumulus deployments in NGAP[^ngap] , the <code>/s3credentials</code> endpoint can be configured to request temporary credentials from the NGAP lambda function: <code>gsfc-ngap-sh-s3-sts-get-keys</code>.  Additionally, these deployments may be configured to limit the scope of the dispensed credentials only to bucket/keypaths that match the user's <a href="https://cmr.earthdata.nasa.gov/search">CMR</a>[^cmr] ACL[^acl] permissions.  Check with your Cumulus deployer to discover what types of credentials are dispensed by this endpoint.</p>
<p>GET requests with a valid cookie to the endpoint return a credentials object that can be used to make direct S3 requests.  The easiest way to get a set of credentials is to visit the endpoint in a browser to handle authentication and redirects.  If you wish to use temporary credentals in AWS, you can find examples on the <code>/s3credentialsREADME</code> endpoint in both javascript and python.</p>
</div><div class="space-bottom4 col6 pad2 prose clip fill-light space-top5" data-reactid="63"><div class='endpoint dark fill-dark round '>
      <div class='round-left pad0y pad1x fill-lighten0 code small endpoint-method'>GET</div>
      <div class='pad0 code small endpoint-url'>/s3credentials</div>
    </div>
<h4 id="example-request-6">Example Request</h4>
<pre class='hljs'>https://example.com/s3credentials</pre>
<h4 id="example-response-4">Example Response</h4>
<pre class='hljs'>{
  <span class="hljs-attr">"accessKeyId"</span>: <span class="hljs-string">"AKIAIOSFODNN7EXAMPLE"</span>,
  <span class="hljs-attr">"secretAccessKey"</span>: <span class="hljs-string">"wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"</span>,
  <span class="hljs-attr">"sessionToken"</span>: <span class="hljs-string">"LONGSTRINGOFCHARACTERSnBeoImkYlERDDHhmwZivcKPd63LUp1uhuZ9bhhIHUjvt++hgRSk9HIMZDEHH9crnukckEZ+FGYrSiwndzjBQ=="</span>,
  <span class="hljs-attr">"expiration"</span>: <span class="hljs-string">"2019-02-27 23:26:56+00:00"</span>
}</pre>
</div></div><div data-title="Command line credentials request" class="keyline-top section contain clearfix " data-reactid="64"><div class="space-bottom8 col6 pad2x prose clip" data-reactid="65"><h3 id="command-line-credentials-request">Command line credentials request</h3>
<p>In order to script the request for credentials you must provide an <code>accessToken</code> cookie in your curl request. This is how the distribution api determines if you are authenticated with Earthdata Login.  If no cookie is provided the authentication workflow is begun.  Here is a sample script to get credentials from the command line.</p>
</div><div class="space-bottom4 col6 pad2 prose clip fill-light space-top5" data-reactid="66"><h4 id="sample-script-to-recieve-credentials">Sample script to recieve credentials.</h4>
<pre class='hljs'><span class="hljs-meta">#! /bin/sh
</span>
COOKIEJAR=cookie.txt
rm -f <span class="hljs-variable">$COOKIEJAR</span>

ORIGIN=$(dirname <span class="hljs-variable">$CUMULUS_DISTRIBUTION_URL</span>)
CREDENTIALS_URL=<span class="hljs-string">"<span class="hljs-variable">$CUMULUS_DISTRIBUTION_URL</span>/s3credentials"</span>

<span class="hljs-comment"># create a base64 hash of your login credentials</span>
AUTH=$(<span class="hljs-built_in">printf</span> <span class="hljs-string">"<span class="hljs-variable">$EARTHDATA_USERNAME</span>:<span class="hljs-variable">$EARTHDATA_PASSWORD</span>"</span> | base64)

<span class="hljs-comment"># Request the Earthdata url with client id and redirect uri to use with Cumulus</span>
AUTHORIZE_URL=$(curl -s -i <span class="hljs-variable">${CREDENTIALS_URL}</span> | grep location | sed -e <span class="hljs-string">"s/^location: //"</span>);

<span class="hljs-comment"># Request an authorization grant code</span>
REDIRECT_URL=$(curl -s -i -X POST \
  -F <span class="hljs-string">"credentials=<span class="hljs-variable">${AUTH}</span>"</span> \
  -H <span class="hljs-string">"Origin: <span class="hljs-variable">${ORIGIN}</span>"</span> \
  <span class="hljs-variable">${AUTHORIZE_URL%$'\r'}</span> | grep Location | sed -e <span class="hljs-string">"s/^Location: //"</span>)

<span class="hljs-comment"># Set the correct cookie via the redirect endpoint with grant code.</span>
curl -i -c <span class="hljs-variable">${COOKIEJAR}</span> -s <span class="hljs-variable">${REDIRECT_URL%$'\r'}</span> | grep location | sed -e <span class="hljs-string">"s/^location: //"</span>

<span class="hljs-comment"># Call the s3credentials endpoint with correct cookies</span>
CREDS=$(curl -i -b <span class="hljs-variable">${COOKIEJAR}</span> -s <span class="hljs-variable">$CREDENTIALS_URL</span>)

<span class="hljs-built_in">echo</span> <span class="hljs-variable">$CREDS</span></pre>
</div></div><div data-title="Non-NGAP deployments" class="keyline-top section contain clearfix " data-reactid="67"><div class="space-bottom8 col6 pad2x prose clip" data-reactid="68"><h3 id="non-ngap-deployments">Non-NGAP deployments</h3>
<p>For non-NGAP deployments that wish to provide temporary credentials, you must provide the name of a lambda available to your stack either by overriding the default <code>sts_credentials_lambda</code> in your Cumulus deployment configuration or by setting the environment variable STSCredentialsLambda on your API.  Your lambda function must take an payload object as described below and return <a href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/Credentials.html">AWS.Credentials</a> appropriate to your use case probably via the <a href="https://docs.aws.amazon.com/STS/latest/APIReference/Welcome.html">AWS Security Token Service</a>.</p>
<p>[^ngap]: NASA-compliant General Application Platform
[^cmr]: Common Metadata Repository
[^acl]: Access Control List</p>
</div><div class="space-bottom4 col6 pad2 prose clip fill-light space-top5" data-reactid="69"><h4 id="sample-sts_credentials_lambda-payload">sample <code>sts_credentials_lambda</code> payload:</h4>
<pre class='hljs'>{
 accesstype: 'sameregion',
 duration: '3600', // one hour max allowed by AWS.
 rolesession: username,
 userid: username
}</pre>
</div></div><div data-title="Temporary S3 Credentials README" class="keyline-top section contain clearfix " data-reactid="70"><div class="space-bottom8 col6 pad2x prose clip" data-reactid="71"><h2 id="temporary-s3-credentials-readme">Temporary S3 Credentials README</h2>
<p>The Cumulus API also provides a convenient documentation page deployed alongside of the <code>/s3credentials</code> endpoint.</p>
<p>Un authenticated GET requests return a webpage that describes the basic use of the <code>/s3credentials</code> endpoint and displays a small example of how to use the returned credential object.</p>
<p><img src="./content/images/exampleResponse.png" alt="image of example response"></p>
</div><div class="space-bottom4 col6 pad2 prose clip fill-light space-top5" data-reactid="72"><div class='endpoint dark fill-dark round '>
      <div class='round-left pad0y pad1x fill-lighten0 code small endpoint-method'>GET</div>
      <div class='pad0 code small endpoint-url'>/s3credentialsREADME</div>
    </div>
<h4 id="example-request-7">Example Request</h4>
<pre class='hljs'>https://example.com/s3credentialsREADME</pre>
<h4 id="example-response-5">Example Response</h4>
<pre class='hljs'>See image to left.</pre>
</div></div></div></div></div><div class="fixed-top space-left16" data-reactid="73"><div class="events fill-light bottom-shadow pad1 col6 pin-topright  " data-reactid="74"><div class="space-right1 small quiet inline" data-reactid="75">Show examples in:</div><div class="rounded-toggle inline short" data-reactid="76"><a class="strong active" data-reactid="77">cURL</a><a class="strong " data-reactid="78">cli</a><a class="strong " data-reactid="79">Python</a><a class="strong " data-reactid="80">JS</a><a class="strong " data-reactid="81">Java</a></div><div class="fr pad0" data-reactid="82"><a title="Display as 1 column" style="cursor:pointer;" class="icon quiet caret-left pad0 fill-darken0 round" data-reactid="83"></a></div></div></div><div class="fill-dark dark bottom-shadow fixed-top pad0 width16" data-reactid="84"><a href="/" class="active space-top1 space-left1 pin-topleft icon round dark pad0 fill-blue" data-reactid="85"></a><div class="strong small pad0
          
          space-left4 line-height15" data-reactid="86">Cumulus Distribution API Documentation</div></div></div></div><!--STOP-->
    <script src='bundle.js'></script>
  </body>
</html>
